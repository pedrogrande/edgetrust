## Summary

Implements S2-02: Guardian task creation with draft-to-open workflow, including quasi-smart contract immutability enforcement.

**Key Features:**

- Guardian-only admin task management API
- Draft → open state transition with immutability locking
- Admin UI for task creation with criteria and incentives
- Event logging (task.created, task.published) with actor tracking
- Transaction-based atomic creation
- Sanctuary-aligned error messages

## Story Link

`/project/trust-builder/product-manager/stories/S2-02-admin-task-creation.md`

## Implementation Details

### API Endpoints (3 new)

- `POST /api/admin/tasks` - Create draft task (transaction: task + criteria + task_incentives + event)
- `PATCH /api/admin/tasks/:id/publish` - Publish draft → open (race condition protected)
- `GET /api/admin/tasks` - List all tasks including drafts (Guardian-only)

### Auth Middleware

- `requireRole()` helper with sanctuary-aligned error messages
- Guardian role check on all admin endpoints (HTTP 403)

### UI Components (3 new)

- `/trust-builder/admin/tasks.astro` - Admin task management page
- `TaskCreateForm.tsx` - Create tasks with dynamic criteria/incentives
- `TaskList.tsx` - View and publish draft tasks

### Event Logging

- `task.created` - Logged on draft creation with metadata (actor_id, task_id, title, group_id, criteria_count, total_points)
- `task.published` - Logged on publish with full metadata and published_at timestamp

### Quasi-Smart Contract Enforcement

- **Immutable after publish**: title, rationale, description, task_type, verification_method, criteria, task_incentives
- **Mutable**: state (open → expired/cancelled), max_completions (increase only)
- HTTP 409 for immutability violations with sanctuary-aligned explanation

### Validation

- Mission validation (must be type='mission', not 'colony')
- At least 1 criterion required
- At least 1 incentive point required
- Race condition protection on publish (checks state='draft')

## Testing

- TypeScript compilation: ✅ Passed (no errors in src/)
- Dev server startup: ✅ Passed (port 4323)
- Ready for manual QA testing

## Schema / Migrations

None (uses existing S1-01 schema)

## Acceptance Criteria

Satisfies all 14 acceptance criteria from enhanced S2-02 story:

1. ✅ Endpoint: POST /api/admin/tasks (Guardian-only)
2. ✅ POST validates mission existence and type='mission'
3. ✅ POST creates task in state='draft', version=1
4. ✅ POST atomically creates task + criteria + task_incentives
5. ✅ POST logs task.created event with actor, metadata
6. ✅ Endpoint: PATCH /api/admin/tasks/:id/publish (Guardian-only)
7. ✅ PATCH transitions draft → open (race condition protected)
8. ✅ PATCH sets published_at timestamp
9. ✅ PATCH logs task.published event
10. ✅ PATCH returns 409 for edit attempts on open tasks
11. ✅ Admin UI: /trust-builder/admin/tasks (Guardian-only)
12. ✅ UI: TaskCreateForm with criteria and incentives
13. ✅ UI: TaskList with publish action
14. ✅ All errors use sanctuary-aligned language

## Files Changed

- Modified: `src/lib/auth/index.ts` - Added requireRole middleware
- New: `src/pages/api/trust-builder/admin/tasks/index.ts` - CRUD endpoints
- New: `src/pages/api/trust-builder/admin/tasks/[id]/publish.ts` - Publish endpoint
- New: `src/pages/trust-builder/admin/tasks.astro` - Admin page
- New: `src/components/trust-builder/admin/TaskCreateForm.tsx` - Creation form
- New: `src/components/trust-builder/admin/TaskList.tsx` - Task listing

Total: 6 files, 935 lines of new code

## Next Steps

1. QA Engineer: Validate all 14 acceptance criteria
2. Product Advisor: Review ontology alignment and contract integrity
3. Merge after QA pass and advisor approval (B+ or higher)
