#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."
echo ""

# TypeScript type check
echo "üìò Checking TypeScript..."
pnpm tsc --noEmit --pretty
if [ $? -ne 0 ]; then
  echo ""
  echo "‚ùå TypeScript errors detected. Please fix them before committing."
  exit 1
fi
echo "‚úÖ TypeScript check passed"
echo ""

# Character encoding check (includes .astro files per S3-01 strategic review)
echo "üîç Checking for character encoding issues..."

# Check staged files for problematic characters
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx|astro)$')

if [ -n "$STAGED_FILES" ]; then
  # Check for smart quotes (' ' " "), en-dash (‚Äì), em-dash (‚Äî)
  BAD_CHARS=$(echo "$STAGED_FILES" | xargs grep -n -E "[''""\u2013\u2014]" 2>/dev/null || true)
  
  if [ -n "$BAD_CHARS" ]; then
    echo ""
    echo "‚ùå Non-ASCII characters detected (smart quotes, en-dashes, or em-dashes):"
    echo ""
    echo "$BAD_CHARS"
    echo ""
    echo "   Please replace:"
    echo "   ' or ' ‚Üí '  (straight single quote)"
    echo "   " or " ‚Üí \"  (straight double quote)"
    echo "   ‚Äì or ‚Äî ‚Üí -  (hyphen-minus)"
    echo ""
    echo "   Tip: Search for these in VS Code and replace with ASCII equivalents"
    echo ""
    exit 1
  fi
fi

echo "‚úÖ Character encoding check passed"
echo ""
echo "‚úÖ All pre-commit checks passed!"
