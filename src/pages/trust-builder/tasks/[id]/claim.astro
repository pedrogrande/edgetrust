---
/**
 * Claim Submission Page
 *
 * Form for submitting proofs against task criteria
 * Requires authentication
 */

import Layout from '@/layouts/Layout.astro';
import { Button } from '@/components/ui/button';
import { Alert, AlertDescription } from '@/components/ui/alert';
import { ClaimForm } from '@/components/trust-builder/ClaimForm';
import { sql } from '@/lib/db/connection';
import { getCurrentUser } from '@/lib/auth';
import { AlertCircle } from 'lucide-react';
import { hasClaimedTask } from '@/lib/db/queries';
import { isValidUUID } from '@/lib/contracts/validators';

const { id } = Astro.params;

// Validate UUID format
if (!id || !isValidUUID(id)) {
  return Astro.redirect('/trust-builder/tasks');
}

// Auth guard
const user = await getCurrentUser(Astro.request, sql);
if (!user) {
  return Astro.redirect(
    `/trust-builder/signin?redirect=/trust-builder/tasks/${id}/claim`
  );
}

// Check if user has already claimed this task
const alreadyClaimed = await hasClaimedTask(user.id, id);
if (alreadyClaimed) {
  // Redirect to dashboard with message
  return Astro.redirect('/trust-builder/dashboard?claim=duplicate');
}

// Fetch task details with criteria
const taskResult = await sql`
  SELECT
    t.id,
    t.title,
    t.state,
    t.max_completions,
    t.proof_type,
    g.name as mission_name
  FROM tasks t
  INNER JOIN groups g ON t.group_id = g.id
  WHERE t.id = ${id}
`;

if (taskResult.length === 0) {
  return Astro.redirect('/trust-builder/tasks');
}

const task = taskResult[0] as {
  id: string;
  title: string;
  state: string;
  max_completions: number | null;
  proof_type: 'text' | 'file' | 'text_or_file';
  mission_name: string;
};

// Check if task is open
if (task.state !== 'open') {
  return Astro.redirect(`/trust-builder/tasks/${id}`);
}

// Check if task has reached max completions
if (task.max_completions !== null) {
  const completionsResult = await sql`
    SELECT COUNT(*) as count
    FROM claims
    WHERE task_id = ${id} AND status = 'approved'
  `;
  const completions = Number((completionsResult[0] as { count: string }).count);

  if (completions >= task.max_completions) {
    return Astro.redirect(`/trust-builder/tasks/${id}`);
  }
}

// Fetch criteria
const criteriaResult = await sql`
  SELECT id, description, verification_method, proof_type, sort_order
  FROM criteria
  WHERE task_id = ${id}
  ORDER BY sort_order
`;

const criteria = criteriaResult as Array<{
  id: string;
  description: string;
  verification_method: string;
  proof_type: string;
  sort_order: number;
}>;

if (criteria.length === 0) {
  return Astro.redirect(`/trust-builder/tasks/${id}`);
}
---

<Layout title={`Submit Claim: ${task.title} - Trust Builder`}>
  <div class="container mx-auto px-4 py-8 max-w-3xl">
    <!-- Back Button -->
    <div class="mb-6">
      <a href={`/trust-builder/tasks/${id}`}>
        <Button variant="ghost" size="sm"> ‚Üê Back to Task </Button>
      </a>
    </div>

    <!-- Page Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-2">Submit Your Claim</h1>
      <p class="text-muted-foreground">
        Mission: {task.mission_name}
      </p>
    </div>

    <!-- Info Alert -->
    <Alert
      className="mb-6 border-blue-200 bg-blue-50 dark:bg-blue-950 dark:border-blue-800"
    >
      <AlertCircle className="h-4 w-4 text-blue-600 dark:text-blue-400" />
      <AlertDescription className="text-blue-900 dark:text-blue-100">
        <strong>What happens next?</strong>
        {
          criteria.every((c) => c.verification_method === 'auto_approve') ? (
            <p class="mt-1">
              This task uses automatic approval. If your proof meets the
              criteria, you'll receive points immediately!
            </p>
          ) : (
            <p class="mt-1">
              Your claim will be reviewed by a community member. You'll be
              notified once it's been evaluated.
            </p>
          )
        }
      </AlertDescription>
    </Alert>

    <!-- Claim Form -->
    <ClaimForm
      client:load
      taskId={id}
      taskTitle={task.title}
      criteria={criteria}
      proofType={task.proof_type}
    />
  </div>
</Layout>
