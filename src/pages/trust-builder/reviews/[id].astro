---
import Layout from '@/layouts/Layout.astro';
import { getCurrentUser } from '@/lib/auth/index';
import { sql } from '@/lib/db/connection';

const currentUser = await getCurrentUser(Astro.request, sql);

if (!currentUser) {
  return Astro.redirect('/trust-builder/signin');
}

const claimId = Astro.params.id;

if (!claimId) {
  return Astro.redirect('/trust-builder/reviews');
}

// Fetch claim details with task, member, criteria, and proofs
const claimResult = await sql`
  SELECT 
    c.id,
    c.member_id,
    c.task_id,
    c.status,
    c.submitted_at,
    c.reviewer_id,
    c.review_deadline,
    c.revision_count,
    c.review_notes,
    t.title as task_title,
    t.description as task_description,
    t.rationale as task_rationale,
    t.verification_method,
    m.display_name as member_display_name,
    m.member_id as member_identifier,
    m.trust_score_cached as member_trust_score
   FROM claims c
   JOIN tasks t ON t.id = c.task_id
   JOIN members m ON m.id = c.member_id
   WHERE c.id = ${claimId}
`;

if (claimResult.length === 0) {
  return Astro.redirect('/trust-builder/reviews');
}

const claim = claimResult[0] as {
  id: string;
  member_id: string;
  task_id: string;
  status: string;
  submitted_at: Date;
  reviewer_id: string | null;
  review_deadline: Date | null;
  revision_count: number;
  review_notes: string | null;
  task_title: string;
  task_description: string;
  task_rationale: string;
  verification_method: string;
  member_display_name: string;
  member_identifier: string;
  member_trust_score: number;
};

// Verify reviewer authorization
if (claim.reviewer_id !== currentUser.id) {
  return Astro.redirect('/trust-builder/reviews');
}

if (claim.status !== 'under_review') {
  return Astro.redirect('/trust-builder/reviews');
}

// Fetch task criteria (AC24: Display prominently)
const criteriaResult = await sql`
  SELECT id, description, proof_type, verification_method, sort_order
   FROM criteria
   WHERE task_id = ${claim.task_id}
   ORDER BY sort_order
`;

const criteria = criteriaResult as Array<{
  id: string;
  description: string;
  proof_type: string;
  verification_method: string;
  sort_order: number;
}>;

// Fetch proofs
const proofsResult = await sql`
  SELECT 
    p.id,
    p.criterion_id,
    p.content_text,
    p.file_url,
    p.file_hash,
    p.file_size,
    p.mime_type,
    c.description as criterion_description
   FROM proofs p
   JOIN criteria c ON c.id = p.criterion_id
   WHERE p.claim_id = ${claimId}
   ORDER BY c.sort_order
`;

const proofs = proofsResult as Array<{
  id: string;
  criterion_id: string;
  content_text: string | null;
  file_url: string | null;
  file_hash: string | null;
  file_size: number | null;
  mime_type: string | null;
  criterion_description: string;
}>;

// Fetch task incentives for context
const incentivesResult = await sql`
  SELECT 
    i.name as incentive_name,
    ti.points
   FROM task_incentives ti
   JOIN incentives i ON i.id = ti.incentive_id
   WHERE ti.task_id = ${claim.task_id}
`;

const incentives = incentivesResult as Array<{
  incentive_name: string;
  points: number;
}>;

const claimData = {
  ...claim,
  criteria,
  proofs,
  incentives,
};
---

<Layout title={`Review: ${claim.task_title} - Trust Builder`}>
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <!-- Header with Sanctuary Culture Reminder -->
    <div class="mb-6">
      <a
        href="/trust-builder/reviews"
        class="text-sm text-muted-foreground hover:text-foreground mb-2 inline-block"
      >
        ‚Üê Back to Review Queue
      </a>
      <h1 class="text-3xl font-bold mb-2">Review Claim</h1>
      <div
        class="bg-blue-50 dark:bg-blue-950 border border-blue-200 dark:border-blue-800 rounded-lg p-3 text-sm"
      >
        <p class="text-blue-800 dark:text-blue-200">
          üèõÔ∏è <strong>Remember:</strong> Your role is to help this member succeed.
          Provide constructive, specific feedback that explains HOW to improve.
        </p>
      </div>
    </div>

    <div id="review-claim-container" data-claim={JSON.stringify(claimData)}>
      <!-- React component mounts here -->
    </div>
  </div>
</Layout>

<script>
  import { createRoot } from 'react-dom/client';
  import { createElement } from 'react';
  import ReviewClaim from '@/components/trust-builder/ReviewClaim';

  const container = document.getElementById('review-claim-container');
  if (container) {
    const claimData = JSON.parse(container.getAttribute('data-claim') || '{}');
    const root = createRoot(container);
    root.render(createElement(ReviewClaim, { claimData }));
  }
</script>
